<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Student Opportunities</title>

<style>
  :root{
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --shadow:0 10px 25px rgba(0,0,0,.08);
  }

  body{margin:0;font-family:Arial,system-ui,sans-serif;background:#fff;color:var(--text);}
  .wrap{max-width:1100px;margin:auto;padding:12px;}

  .status{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 12px;
    background:#f9fafb;
    margin-bottom:12px;
    font-size:14px;
  }

  /* SEARCH */
  .searchbar{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:12px;
  }
  .searchbar input{
    flex:1;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px 14px;
    font-size:14px;
    outline:none;
  }
  .searchbar input:focus{
    box-shadow:0 0 0 3px rgba(17,24,39,.12);
  }
  .clear-search{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    cursor:pointer;
  }
  .clear-search:hover{background:#f3f4f6;}

  /* FILTERS */
  .filters{
    display:grid;
    grid-template-columns:repeat(3, minmax(0,1fr));
    gap:12px;
    margin-bottom:10px;
  }
  @media(max-width:900px){ .filters{grid-template-columns:1fr;} }

  .filter{
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px;
    background:#fff;
  }

  .filter-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:8px;
  }

  .filter-title{
    font-size:12px;
    color:var(--muted);
    font-weight:900;
    letter-spacing:.02em;
    margin:0;
  }

  .clear{
    border:1px solid var(--border);
    background:#fff;
    border-radius:12px;
    padding:8px 10px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
  }
  .clear:hover{background:#f3f4f6;}

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }

  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    user-select:none;
    font-size:13px;
    font-weight:800;
  }

  .chip input{
    width:16px;height:16px;
    margin:0;
  }

  .chip[data-checked="true"]{
    background:#111827;
    color:#fff;
    border-color:#111827;
  }

  .actions{
    display:flex;
    justify-content:flex-end;
    margin-bottom:12px;
    gap:10px;
  }
  .reset{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    cursor:pointer;
  }
  .reset:hover{background:#f3f4f6;}

  /* CARDS */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr);}}
  @media(max-width:600px){.grid{grid-template-columns:1fr;}}

  .card{
    border:1px solid var(--border);
    border-radius:16px;
    padding:16px;
    background:#fff;
    box-shadow:0 8px 20px rgba(0,0,0,.08);
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .title{margin:0 0 12px 0;font-size:20px;line-height:1.25;}
  .meta{font-size:14px;margin-bottom:14px;}
  .meta div{margin-bottom:6px;}

  .details{
    background:#111827;color:#fff;border:none;padding:10px 14px;border-radius:10px;
    font-weight:900;cursor:pointer;
  }
  .details:hover{background:#000;}

  /* MODAL */
  .backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.5);
    display:none;align-items:center;justify-content:center;padding:20px;
    z-index:9999;
  }
  .backdrop.open{display:flex;}
  .modal{background:#fff;max-width:750px;width:100%;border-radius:18px;padding:20px;}
  .close{float:right;cursor:pointer;font-weight:900;}

  /* EMPTY */
  .empty{
    display:none;
    margin-top:12px;
    border:1px dashed var(--border);
    border-radius:14px;
    padding:14px;
    color:var(--muted);
    text-align:center;
  }
  .empty.show{display:block;}
</style>
</head>

<body>
<div class="wrap">
  <div id="status" class="status">Loading opportunities…</div>

  <!-- SEARCH -->
  <div class="searchbar">
    <input id="searchInput" type="text" placeholder="Search opportunity names (e.g., NASA, lab, internship)"/>
    <button id="clearSearch" class="clear-search" type="button">Clear</button>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <div class="filter">
      <div class="filter-head">
        <p class="filter-title">Domain (multi-select)</p>
        <button id="clearDomain" class="clear" type="button">Clear</button>
      </div>
      <div id="domainChips" class="chips"></div>
    </div>

    <div class="filter">
      <div class="filter-head">
        <p class="filter-title">Education level (multi-select)</p>
        <button id="clearEdu" class="clear" type="button">Clear</button>
      </div>
      <div id="eduChips" class="chips"></div>
    </div>

    <div class="filter">
      <div class="filter-head">
        <p class="filter-title">Location type (multi-select)</p>
        <button id="clearLoc" class="clear" type="button">Clear</button>
      </div>
      <div id="locChips" class="chips"></div>
    </div>
  </div>

  <div class="actions">
    <button id="resetBtn" class="reset" type="button">Reset all</button>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty">No opportunities match your search/filters.</div>
</div>

<div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div>
      <span id="closeBtn" class="close">✕</span>
      <h2 id="modalTitle"></h2>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
  // ===============================
  // ✅ PASTE YOUR *PUBLISHED CSV* LINK BELOW
  // Must look like .../pub?output=csv  (or ...&gid=...&single=true&output=csv)
  // ===============================
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSrvzLfDN30Re_NAwIKCx3V1RTU1A_58ohgRA2dSLyDLJmSgFPMYK0YgcF2SsbgaYVT0QmY5ZYsN666/pub?gid=1646305040&single=true&output=csv";
  // ===============================

  // Column indices (0-based): B=1, AE=30, AF=31, AG=32
  const COL_TITLE = 1;
  const COL_DOMAIN = 30;
  const COL_EDU = 31;
  const COL_LOCATION = 32;

  // Adjust if needed
  const COL_DESCRIPTION = 2; // C
  const COL_URL = 3;         // D

  let opportunities = [];

  // Multi-select sets
  const selected = {
    domain: new Set(),
    edu: new Set(),
    location: new Set()
  };

  // Search state
  let searchQuery = "";

  const statusEl = document.getElementById("status");
  const grid = document.getElementById("grid");
  const emptyEl = document.getElementById("empty");

  const searchInput = document.getElementById("searchInput");
  const clearSearch = document.getElementById("clearSearch");

  const domainChips = document.getElementById("domainChips");
  const eduChips = document.getElementById("eduChips");
  const locChips = document.getElementById("locChips");

  const clearDomain = document.getElementById("clearDomain");
  const clearEdu = document.getElementById("clearEdu");
  const clearLoc = document.getElementById("clearLoc");
  const resetBtn = document.getElementById("resetBtn");

  const backdrop = document.getElementById("backdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const closeBtn = document.getElementById("closeBtn");

  function parseTags(cell){
    const raw = String(cell ?? "").trim();
    if(!raw) return [];
    return raw
      .split(/[;,]/g)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function anySelectedMatch(selectedSet, tagsArray){
    if(selectedSet.size === 0) return true; // no filter in this category
    for(const t of tagsArray){
      if(selectedSet.has(t)) return true;   // OR within category
    }
    return false;
  }

  function parseCSV(text){
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for(let i=0;i<text.length;i++){
      const c = text[i];
      const next = text[i+1];

      if(c === '"' && inQuotes && next === '"'){ cell += '"'; i++; continue; }
      if(c === '"'){ inQuotes = !inQuotes; continue; }

      if(c === "," && !inQuotes){ row.push(cell); cell=""; continue; }

      if((c === "\n" || c === "\r") && !inQuotes){
        if(c === "\r" && next === "\n") i++;
        row.push(cell); rows.push(row);
        row=[]; cell="";
        continue;
      }

      cell += c;
    }

    if(cell.length || row.length){ row.push(cell); rows.push(row); }
    return rows;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function uniqSorted(values){
    const set = new Set(values.map(v => String(v || "").trim()).filter(Boolean));
    return Array.from(set).sort((a,b) => a.localeCompare(b));
  }

  async function loadData(){
    if(!SHEET_URL || SHEET_URL.includes("PASTE_YOUR_PUBLISHED")){
      throw new Error("SHEET_URL is not set. Paste your published CSV link into SHEET_URL.");
    }

    const url = SHEET_URL + (SHEET_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("Fetch failed: HTTP " + res.status);

    const text = await res.text();
    if(text.trim().startsWith("<!DOCTYPE") || text.includes("<html")){
      throw new Error("Sheet link returned HTML, not CSV. Use Publish to web → CSV (output=csv).");
    }

    const rows = parseCSV(text).filter(r => r.some(v => String(v).trim() !== ""));
    if(rows.length <= 1) return [];

    const out = [];
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      const title = (r[COL_TITLE] ?? "").trim();
      if(!title) continue;

      const domainCell = (r[COL_DOMAIN] ?? "").trim();
      const eduCell = (r[COL_EDU] ?? "").trim();
      const locCell = (r[COL_LOCATION] ?? "").trim();

      out.push({
        id: "row-" + i,
        title,

        domainRaw: domainCell,
        eduRaw: eduCell,
        locRaw: locCell,

        domainTags: parseTags(domainCell),
        eduTags: parseTags(eduCell),
        locTags: parseTags(locCell),

        description: (r[COL_DESCRIPTION] ?? "").trim(),
        url: (r[COL_URL] ?? "").trim(),
      });
    }
    return out;
  }

  function buildChips(container, values, groupKey){
    container.innerHTML = "";
    for(const v of values){
      const label = document.createElement("label");
      label.className = "chip";
      label.dataset.group = groupKey;
      label.dataset.value = v;
      label.dataset.checked = "false";
      label.innerHTML = `<input type="checkbox"/><span>${escapeHtml(v)}</span>`;
      container.appendChild(label);
    }
  }

  function syncChipStyles(container, groupKey){
    container.querySelectorAll(".chip").forEach(chip => {
      const value = chip.dataset.value;
      const isOn = selected[groupKey].has(value);
      chip.dataset.checked = isOn ? "true" : "false";
      chip.querySelector("input").checked = isOn;
    });
  }

  function titleMatchesSearch(title){
    const q = searchQuery.trim().toLowerCase();
    if(!q) return true;
    return String(title || "").toLowerCase().includes(q);
  }

  function getFiltered(){
    return opportunities.filter(o => {
      const searchOk = titleMatchesSearch(o.title);
      const domainOk = anySelectedMatch(selected.domain, o.domainTags);
      const eduOk = anySelectedMatch(selected.edu, o.eduTags);
      const locOk = anySelectedMatch(selected.location, o.locTags);
      return searchOk && domainOk && eduOk && locOk; // AND across everything
    });
  }

  function renderCards(list){
    grid.innerHTML = "";
    emptyEl.classList.toggle("show", list.length === 0);

    for(const opp of list){
      const card = document.createElement("div");
      card.className = "card";

      // Architecture hooks
      card.dataset.domain = opp.domainRaw;
      card.dataset.edu = opp.eduRaw;
      card.dataset.location = opp.locRaw;

      card.innerHTML = `
        <h3 class="title">${escapeHtml(opp.title)}</h3>
        <div class="meta">
          <div><strong>Domain:</strong> ${escapeHtml(opp.domainRaw)}</div>
          <div><strong>Education Level:</strong> ${escapeHtml(opp.eduRaw)}</div>
          <div><strong>Location Type:</strong> ${escapeHtml(opp.locRaw)}</div>
        </div>
        <button class="details" data-id="${escapeHtml(opp.id)}">Details</button>
      `;
      grid.appendChild(card);
    }
  }

  function updateStatus(filteredCount){
    const parts = [];
    const q = searchQuery.trim();
    if(q) parts.push(`Search: "${q}"`);
    if(selected.domain.size) parts.push(`Domain: ${Array.from(selected.domain).join(", ")}`);
    if(selected.edu.size) parts.push(`Edu: ${Array.from(selected.edu).join(", ")}`);
    if(selected.location.size) parts.push(`Location: ${Array.from(selected.location).join(", ")}`);

    statusEl.textContent = parts.length
      ? `Showing ${filteredCount} / ${opportunities.length} (${parts.join(" • ")})`
      : `Showing ${filteredCount} / ${opportunities.length}`;
  }

  function applyAndRender(){
    const filtered = getFiltered();
    renderCards(filtered);
    updateStatus(filtered.length);
    syncChipStyles(domainChips, "domain");
    syncChipStyles(eduChips, "edu");
    syncChipStyles(locChips, "location");
  }

  function attachChipHandler(container, groupKey){
    container.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;

      const value = chip.dataset.value;
      if(selected[groupKey].has(value)) selected[groupKey].delete(value);
      else selected[groupKey].add(value);

      applyAndRender();
    });
  }

  attachChipHandler(domainChips, "domain");
  attachChipHandler(eduChips, "edu");
  attachChipHandler(locChips, "location");

  clearDomain.addEventListener("click", () => { selected.domain.clear(); applyAndRender(); });
  clearEdu.addEventListener("click", () => { selected.edu.clear(); applyAndRender(); });
  clearLoc.addEventListener("click", () => { selected.location.clear(); applyAndRender(); });

  // SEARCH EVENTS
  // small debounce so it doesn't re-render on every keystroke too aggressively
  let searchTimer = null;
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      searchQuery = searchInput.value || "";
      applyAndRender();
    }, 120);
  });

  clearSearch.addEventListener("click", () => {
    searchInput.value = "";
    searchQuery = "";
    applyAndRender();
    searchInput.focus();
  });

  resetBtn.addEventListener("click", () => {
    selected.domain.clear();
    selected.edu.clear();
    selected.location.clear();
    searchInput.value = "";
    searchQuery = "";
    applyAndRender();
  });

  // DETAILS MODAL
  grid.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-id]");
    if(!btn) return;

    const opp = opportunities.find(o => o.id === btn.dataset.id);
    if(!opp) return;

    modalTitle.textContent = opp.title;

    const desc = escapeHtml(opp.description).replaceAll("\n","<br>");
    const link = opp.url
      ? `<p style="margin-top:12px;"><a href="${escapeHtml(opp.url)}" target="_blank" rel="noopener">Open link ↗</a></p>`
      : "";

    modalBody.innerHTML = `<p>${desc}</p>${link}`;
    backdrop.classList.add("open");
    backdrop.setAttribute("aria-hidden", "false");
  });

  closeBtn.addEventListener("click", () => {
    backdrop.classList.remove("open");
    backdrop.setAttribute("aria-hidden", "true");
  });

  backdrop.addEventListener("click", (e) => {
    if(e.target === backdrop){
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
    }
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && backdrop.classList.contains("open")){
      backdrop.classList.remove("open");
      backdrop.setAttribute("aria-hidden", "true");
    }
  });

  // INIT
  (async function init(){
    try{
      opportunities = await loadData();

      const domainOpts = uniqSorted(opportunities.flatMap(o => o.domainTags));
      const eduOpts = uniqSorted(opportunities.flatMap(o => o.eduTags));
      const locOpts = uniqSorted(opportunities.flatMap(o => o.locTags));

      buildChips(domainChips, domainOpts, "domain");
      buildChips(eduChips, eduOpts, "edu");
      buildChips(locChips, locOpts, "location");

      applyAndRender();
    }catch(err){
      console.error(err);
      statusEl.textContent = "ERROR: " + err.message;
      renderCards([]);
      emptyEl.classList.add("show");
    }
  })();
</script>
</body>
</html>
